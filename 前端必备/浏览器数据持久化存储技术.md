# 浏览器数据持久化存储技术

> 同源策略：
>
> - 协议相同
> - 域名相同
> - 端口相同

### 1.cookie（遵循同源策略）

##### 1.1概念

Cookie(或Cookies),指网站为了辨别用户身份或Session跟踪而储存在用户浏览器端的纯文本数据。Cookie 信息一般会通过HTTP请求发送到服务器端。一条 Cookie记录主要由键、值、域、过期时间和大小组成，一般用 于保存用户的网站认证信息。

浏览器中Cookie的最大长度和单个域名支持的Cookie个数由浏览器的不同来决定。在Internet Explorer7以上版本、Firefox等浏览器中，支持的Cookie记录最多是50条，Chrome、 Safari 浏览器上则没有限制，Opera浏览器上最多支持30条，而且我们通常认为Cookie的最大长度限制为4KB (4095字节到4097字节)。

##### 1.2cookie组成结构

- name:  cookie的名称

- value:   cookie的值

- domain:  可以访问此cookie的域名

  > **domain参数可以设置父域名以及自身，但不能设置其它域名，包括子域名，否则cookie不起作用。**
  >
  > 自身所在的域名可以访问自身以及自身域名以上的cookie，比如二级域名可以访问二级域名、一级域名或者顶级域名里面的cookie。

- path:  可以访问此cookie的页面路径，默认为“/”

  比如domain是abc.com,path是/test，那么只有/test路径下的页面可以读取此cookie。

- expires/Max-age: cookie的超时时间

  > cookie的默认有效期是当前会话（即把整个浏览器都关闭会话就结束）
  >
  > 如果你想要cookie存在一段时间，那么你可以通过设置Expires属性（绝对时间）为未来的一个时间节点。但是这个属性逐渐被max-age取代。
  >
  > - max-age>0：cookie则会在max-age秒之后被删除
  > - max-age<0：表示临时存储，不会生出cookie文件，只会存在浏览器内存中，且只会在打开的浏览器窗口或者子窗口有效，一旦浏览器关闭，cookie就会消失
  > - max-age=0：删除cookie

- size：cookie的大小

- **httponly：**若此属性为true,那么前端不能通过document.cookie来访问cookie。能有效的防止xss攻击。

  > httponly设置样例：（java版本）
  >
  > response.setHeader("Set-Cookie", "cookiename=value;
  > Path=/;Domain=domainvalue;Max-Age=seconds;HTTPOnly");

- **secure：**设置是否只能通过https来传递此cookie

- **samesite：**用来限制第三方cookie，从而减少安全风险。用来防止CSRF攻击和用户追踪。

  默认值为lax。

  > 它有以下3个取值：
  >
  > - strict：完全禁止第三方 Cookie，跨站点时，任何情况下都不会发送 Cookie。换言之，只有当前网页的 URL 与请求目标一致，才会带上 Cookie。
  >
  >   ```
  >   Set-Cookie: CookieName=CookieValue; SameSite=Strict;
  >   ```
  >
  >   这个规则过于严格，可能造成非常不好的用户体验。比如，当前网页有一个 GitHub 链接，用户点击跳转就不会带有 GitHub 的 Cookie，跳转过去总是未登陆状态。
  >
  > - lax：`Lax`规则稍稍放宽，大多数情况也是不发送第三方 Cookie，但是导航到目标网址的 Get 请求除外。
  >
  >   ```
  >   Set-Cookie: CookieName=CookieValue; SameSite=Lax;
  >   ```
  >
  >   导航到目标网站的get请求，只包括三种情况：链接、预加载请求、get表单。
  >
  >   | 请求类型  |                 示例                 |    正常情况 | Lax         |
  >   | :-------- | :----------------------------------: | ----------: | :---------- |
  >   | 链接      |         `<a href="..."></a>`         | 发送 Cookie | 发送 Cookie |
  >   | 预加载    | `<link rel="prerender" href="..."/>` | 发送 Cookie | 发送 Cookie |
  >   | GET 表单  |  `<form method="GET" action="...">`  | 发送 Cookie | 发送 Cookie |
  >   | POST 表单 | `<form method="POST" action="...">`  | 发送 Cookie | 不发送      |
  >   | iframe    |    `<iframe src="..."></iframe>`     | 发送 Cookie | 不发送      |
  >   | AJAX      |            `$.get("...")`            | 发送 Cookie | 不发送      |
  >   | Image     |          `<img src="...">`           | 发送 Cookie | 不发送      |
  >
  >   设置了`Strict`或`Lax`以后，基本就杜绝了 CSRF 攻击。当然，前提是用户浏览器支持 SameSite 属性。
  >
  > - none：Chrome 计划将`Lax`变为默认设置。这时，网站可以选择显式关闭`SameSite`属性，将其设为`None`。不过，前提是必须同时设置`Secure`属性（Cookie 只能通过 HTTPS 协议发送），否则无效。
  >
  >   下面的设置无效：
  >
  >   ```
  >   Set-Cookie: widget_session=abc123; SameSite=None
  >   ```
  >
  >   下面的设置有效：
  >
  >   ```
  >   Set-Cookie: widget_session=abc123; SameSite=None; Secure
  >   ```

##### 1.3应用场景

- 可以利用cookie跟踪统计用户访问该网站的习惯，比如什么时间访问，访问了哪些页面，在网页的停留时间等等。利用这些信息，可以为用户提供个性化的服务或者可以作为了解所有用户行为的工具，对于网站经营策略的改进有一定的参考价值。
- 记录用户登录信息，这样下次访问时就可以不需要输入自己的用户、密码了。

### 2.sessionStorage（遵循同源策略）

##### 2.1概念

sessionStorage用于本地存储一 个会话(session) 中的数据,这些数据只有在同一个窗口中的页面才能访问并且当窗口结束后数据也随之销毁。因此sessionstorage不是 一种持久化的本地存储，仅仅是会话级别的存储。也就是说只要这个浏览器窗口没有关闭，即使刷新页面或进入**同源**另一页面， 数据仍然存在。关闭窗口后，sessionstorage即被销毁。

为了更好的理解sessionStorage,我们来看个例子：

例如你在浏览器中打开了两个相同地址的页面A、B，虽然这两个页面的源完全一样，但是他们还是不能共享数据，因为他们是不同窗口的，但是如果是一个窗口中，有两个同源的iframe元素的话，这两个iframe的sessionStorage是可以互通的。

##### 2.2应用场景

- 用于存储一些当前页面刷新之后也存在的数据，比如音乐播放器恢复播放进度条。
- 可以用于页面传值（只要是同一窗口下就行）

### 3.localStorage（遵循同源策略）

##### 3.1概念

localStorage和sessionStotage一样是html5新增的本地存储技术，localStorage中的数据除非用户手动删除，否则数据一直存在。

##### 3.2应用场景

- 存储该浏览器对页面的访问次数

### 4.HTTP缓存

##### 4.1基本概念

##### 4.2相关header概念

请求头：

- If-Modified-Since：资源最近的修改时间，由浏览器告诉服务器。
- If-None-Match：缓存资源标识，由浏览器告诉服务器。

响应头：

- Expires：代表资源的过期时间
- Last-Modified：资源最近修改时间，由服务器告诉浏览器。
- Etag：资源标识，由服务器告诉浏览器。

请求/响应头：

- Cache-Control：控制缓存的行为

##### 4.3缓存过程

### 5.常见面试题

##### 5.1Cookie、sessionStorage、localStorage的区别

共同点：都是保存在浏览器端，并且是同源的

不同点：

- 生命周期
  - Cookie：可设置失效时间，否则默认为关闭浏览器后失效
  - Sessionstorage：仅在当前网页会话下有效，关闭页面或浏览器后就会被清除
  - Localstorage:除非被手动清除，否则永久保存
- 存放数据容量
  - Cookie：4k左右
  - sessionstorage和Localstorage：可以保存5M的信息
- http请求
  - Cookie：每次都会携带在http头中，如果使用cookie保存过多数据会带来性能问题
  - sessionstorage和Localstorage：仅在客户端即浏览器中保存，不参与和服务器的通信

5.2