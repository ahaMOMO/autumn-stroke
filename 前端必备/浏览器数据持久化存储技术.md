# 浏览器数据持久化存储技术

### 1.cookie

##### 1.1概念

Cookie(或Cookies),指网站为了辨别用户身份或Session跟踪而储存在用户浏览器端的纯文本数据。Cookie 信息一般会通过HTTP请求发送到服务器端。一条 Cookie记录主要由键、值、域、过期时间和大小组成，一般用 于保存用户的网站认证信息。

浏览器中Cookie的最大长度和单个域名支持的Cookie个数由浏览器的不同来决定。在Internet Explorer7以上版本、Firefox等浏览器中，支持的Cookie记录最多是50条，Chrome、 Safari 浏览器上则没有限制，Opera浏览器上最多支持30条，而且我们通常认为Cookie的最大长度限制为4KB (4095字节到4097字节)。

##### 1.2cookie组成结构

- name:  cookie的名称

- value:   cookie的值

- domain:  可以访问此cookie的域名

  > **domain参数可以设置父域名以及自身，但不能设置其它域名，包括子域名，否则cookie不起作用。**
  >
  > 自身所在的域名可以访问自身以及自身域名以上的cookie，比如二级域名可以访问二级域名、一级域名或者顶级域名里面的cookie。

- path:  可以访问此cookie的页面路径，默认为“/”

  比如domain是abc.com,path是/test，那么只有/test路径下的页面可以读取此cookie。

- expires/Max-age: cookie的超时时间

  > cookie的默认有效期是当前会话（即把整个浏览器都关闭会话就结束）
  >
  > 如果你想要cookie存在一段时间，那么你可以通过设置Expires属性（绝对时间）为未来的一个时间节点。但是这个属性逐渐被max-age取代。
  >
  > - max-age>0：cookie则会在max-age秒之后被删除
  > - max-age<0：表示临时存储，不会生出cookie文件，只会存在浏览器内存中，且只会在打开的浏览器窗口或者子窗口有效，一旦浏览器关闭，cookie就会消失
  > - max-age=0：删除cookie

- size：cookie的大小

- **httponly：**若此属性为true,那么前端不能通过document.cookie来访问cookie。能有效的防止xss攻击。

  > httponly设置样例：（java版本）
  >
  > response.setHeader("Set-Cookie", "cookiename=value;
  > Path=/;Domain=domainvalue;Max-Age=seconds;HTTPOnly");

- **secure：**设置是否只能通过https来传递此cookie

- **samesite：**用来限制第三方cookie，从而减少安全风险。用来防止CSRF攻击和用户追踪。

  默认值为lax。

  > 它有以下3个取值：
  >
  > - strict：完全禁止第三方 Cookie，跨站点时，任何情况下都不会发送 Cookie。换言之，只有当前网页的 URL 与请求目标一致，才会带上 Cookie。
  >
  >   ```
  >   Set-Cookie: CookieName=CookieValue; SameSite=Strict;
  >   ```
  >
  >   这个规则过于严格，可能造成非常不好的用户体验。比如，当前网页有一个 GitHub 链接，用户点击跳转就不会带有 GitHub 的 Cookie，跳转过去总是未登陆状态。
  >
  > - lax：`Lax`规则稍稍放宽，大多数情况也是不发送第三方 Cookie，但是导航到目标网址的 Get 请求除外。
  >
  >   ```
  >   Set-Cookie: CookieName=CookieValue; SameSite=Lax;
  >   ```
  >
  >   导航到目标网站的get请求，只包括三种情况：链接、预加载请求、get表单。
  >
  >   | 请求类型  |                 示例                 |    正常情况 | Lax         |
  >   | :-------- | :----------------------------------: | ----------: | :---------- |
  >   | 链接      |         `<a href="..."></a>`         | 发送 Cookie | 发送 Cookie |
  >   | 预加载    | `<link rel="prerender" href="..."/>` | 发送 Cookie | 发送 Cookie |
  >   | GET 表单  |  `<form method="GET" action="...">`  | 发送 Cookie | 发送 Cookie |
  >   | POST 表单 | `<form method="POST" action="...">`  | 发送 Cookie | 不发送      |
  >   | iframe    |    `<iframe src="..."></iframe>`     | 发送 Cookie | 不发送      |
  >   | AJAX      |            `$.get("...")`            | 发送 Cookie | 不发送      |
  >   | Image     |          `<img src="...">`           | 发送 Cookie | 不发送      |
  >
  >   设置了`Strict`或`Lax`以后，基本就杜绝了 CSRF 攻击。当然，前提是用户浏览器支持 SameSite 属性。
  >
  > - none：Chrome 计划将`Lax`变为默认设置。这时，网站可以选择显式关闭`SameSite`属性，将其设为`None`。不过，前提是必须同时设置`Secure`属性（Cookie 只能通过 HTTPS 协议发送），否则无效。
  >
  >   下面的设置无效：
  >
  >   ```
  >   Set-Cookie: widget_session=abc123; SameSite=None
  >   ```
  >
  >   下面的设置有效：
  >
  >   ```
  >   Set-Cookie: widget_session=abc123; SameSite=None; Secure
  >   ```

##### 1.3应用场景

- 可以利用cookie跟踪统计用户访问该网站的习惯，比如什么时间访问，访问了哪些页面，在网页的停留时间等等。利用这些信息，可以为用户提供个性化的服务或者可以作为了解所有用户行为的工具，对于网站经营策略的改进有一定的参考价值。
- 记录用户登录信息，这样下次访问时就可以不需要输入自己的用户、密码了。